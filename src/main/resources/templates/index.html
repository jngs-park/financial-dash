<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Financial Dash</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 16px;
      margin: 0;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: #f2f2f2;
      font-size: 14px;
    }
    .chart-wrap {
      max-width: 980px;
      width: 100%;
      height: 420px;
      position: relative;
    }
    canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }
    #debug {
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      background: #0b1020;
      color: #d6e1ff;
      padding: 10px;
      border-radius: 8px;
      max-width: 980px;
    }
  </style>
</head>
<body>

<div class="row">
    <h2 style="margin:0;">KRW-BTC Price History</h2>
    <div class="badge" id="trendBadge">Trend: -</div>
    <div class="badge" id="lastBadge">Last: -</div>
</div>

<div class="chart-wrap">
    <canvas id="priceChart"></canvas>
</div>

<div id="debug">Loading...</div>

<script>
const MARKET = "KRW-BTC";
const API_URL = `/api/market/upbit/history?market=${MARKET}`;
const REFRESH_MS = 3000;
const WINDOW_MIN = 10;

let chart;

/* ================= utils ================= */

function formatKST(d) {
  return d.toLocaleTimeString("ko-KR", { hour12: false });
}

function formatKRW(n) {
  return Number(n).toLocaleString("ko-KR");
}

function setDebug(lines) {
  document.getElementById("debug").textContent = lines.join("\n");
}

function movingAverage(points, window) {
  return points.map((p, i) => {
    if (i < window - 1) return { x: p.x, y: null };
    const slice = points.slice(i - window + 1, i + 1);
    const avg = slice.reduce((s, v) => s + v.y, 0) / window;
    return { x: p.x, y: avg };
  });
}

/* ================= chart ================= */

function ensureChart() {
  const ctx = document.getElementById("priceChart").getContext("2d");

  chart = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [
        {
          label: "BTC Price",
          data: [],
          parsing: false,
          pointRadius: 0,
          borderWidth: 2,
          tension: 0.2,
          borderColor: "#4CAF50",
        },
        {
          label: "MA5",
          data: [],
          parsing: false,
          pointRadius: 0,
          borderWidth: 1.5,
          borderColor: "#ff9800"
        },
        {
          label: "MA20",
          data: [],
          parsing: false,
          pointRadius: 0,
          borderWidth: 1.5,
          borderColor: "#2196f3"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: false,
      scales: {
        x: {
          type: "time",
          time: {
            unit: "second",
            displayFormats: { second: "HH:mm:ss" }
          },
          ticks: { maxTicksLimit: 8 }
        },
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

/* ================= data ================= */

async function loadHistory() {
  const debug = [];
  debug.push(`Fetching: ${API_URL}`);

  const res = await fetch(API_URL, { cache: "no-store" });
  const raw = await res.text();
  debug.push(`HTTP ${res.status}`);

  if (!res.ok) {
    debug.push(raw.slice(0, 200));
    setDebug(debug);
    return;
  }

  const data = JSON.parse(raw);
  const list = Array.isArray(data) ? data : [];

  const points = list
    .map(p => ({
      x: new Date(p.createdAt ?? p.fetchedAt),
      y: Number(p.price)
    }))
    .filter(p => !isNaN(p.y));

  if (!chart) ensureChart();

  const now = Date.now();
  const min = now - WINDOW_MIN * 60 * 1000;

  chart.options.scales.x.min = min;
  chart.options.scales.x.max = now;

  chart.data.datasets[0].data = points;
  chart.data.datasets[1].data = movingAverage(points, 5);
  chart.data.datasets[2].data = movingAverage(points, 20);

  chart.update("none");

  const last = points.at(-1);
  document.getElementById("lastBadge").textContent =
    `Last: ${formatKRW(last.y)} (${formatKST(last.x)})`;

  const first = points.find(p => p.x.getTime() >= min);
  const pct = ((last.y - first.y) / first.y) * 100;
  const dir = pct > 0 ? "↑ 상승" : "↓ 하락";

  document.getElementById("trendBadge").textContent =
    `Trend: ${dir} (${pct.toFixed(3)}%)`;

  debug.push(`Loaded ${points.length} points`);
  setDebug(debug);
}

ensureChart();
loadHistory();
setInterval(loadHistory, REFRESH_MS);
</script>
</body>
</html>