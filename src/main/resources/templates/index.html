<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Financial Dash</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<h2>KRW-BTC Price History</h2>

<div id="status">Loading...</div>
<canvas id="priceChart" width="900" height="420"></canvas>

<script>
const market = "KRW-BTC";
const API_URL = `/api/market/upbit/history?market=${market}`;

let chart;

function formatKSTTime(date) {
  return date.toLocaleTimeString("ko-KR", {
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false
  });
}

async function loadHistoryAndRender() {
  const statusEl = document.getElementById("status");
  statusEl.innerText = `Fetching: ${API_URL}`;

  const res = await fetch(API_URL);
  if (!res.ok) {
    const text = await res.text();
    statusEl.innerText = `HTTP ${res.status} - ${text.slice(0, 120)}`;
    return;
  }

  const data = await res.json();
  if (!Array.isArray(data) || data.length === 0) {
    statusEl.innerText = "OK but empty data";
    if (chart) {
      chart.data.labels = [];
      chart.data.datasets[0].data = [];
      chart.update("none");
    }
    return;
  }

  // labels(시간 문자열) + values(가격)로 분리
  const labels = data.map(x => formatKSTTime(new Date(x.createdAt)));
  const values = data.map(x => Number(x.price));

  statusEl.innerText = `✅ Loaded ${data.length} points / last=${labels[labels.length - 1]}`;

  if (!chart) {
    const ctx = document.getElementById("priceChart");
    chart = new Chart(ctx, {
      type: "line",
      data: {
        labels,
        datasets: [{
          label: market,
          data: values,
          pointRadius: 0,
          tension: 0.2
        }]
      },
      options: {
        animation: false,
        responsive: true,
        scales: {
          x: {
            ticks: {
              // 너무 빽빽하면 일부만 표시
              maxTicksLimit: 10
            }
          },
          y: { beginAtZero: false }
        }
      }
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update("none");
  }
}

loadHistoryAndRender();
setInterval(loadHistoryAndRender, 3000);
</script>
</body>
</html>