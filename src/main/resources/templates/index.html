<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Financial Dash</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

    <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 16px;
      margin: 0;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      background: #f2f2f2;
      font-size: 14px;
    }
    .chart-wrap {
      max-width: 980px;
      width: 100%;
      height: 420px;      /* ✅ 높이 고정: 브라우저가 길어지는 문제 방지 */
      position: relative; /* Chart.js responsive에서 권장 */
    }
    canvas {
      width: 100% !important;
      height: 100% !important; /* ✅ 컨테이너 높이를 그대로 사용 */
      display: block;
    }
    #debug {
      margin-top: 10px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      font-size: 12px;
      background: #0b1020;
      color: #d6e1ff;
      padding: 10px;
      border-radius: 8px;
      max-width: 980px;
    }
  </style>
</head>
<body>

<div class="row">
    <h2 style="margin: 0;">KRW-BTC Price History</h2>
    <div class="badge" id="trendBadge">Trend: -</div>
    <div class="badge" id="lastBadge">Last: -</div>
</div>

<div class="chart-wrap">
    <canvas id="priceChart"></canvas>
</div>

<div id="debug">Loading...</div>

<script>
    const MARKET = "KRW-BTC";
    const API_URL = `/api/market/upbit/history?market=${encodeURIComponent(MARKET)}`;

    const REFRESH_MS = 3000;
    const WINDOW_MIN = 10; // ✅ 최근 10분만 화면에 고정 표시

    let chart;

    function formatKST(isoOrDate) {
      const d = (isoOrDate instanceof Date) ? isoOrDate : new Date(isoOrDate);
      return d.toLocaleTimeString("ko-KR", { hour12: false });
    }

    function formatKRW(n) {
      try { return Number(n).toLocaleString("ko-KR"); }
      catch { return String(n); }
    }

    function setDebug(lines) {
      document.getElementById("debug").textContent = lines.join("\n");
    }

    function calcTrend(points) {
      // points: [{x:Date, y:number}]
      if (!points || points.length < 2) return { pct: 0, dir: "-", label: "데이터 부족" };

      const first = points[0].y;
      const last  = points[points.length - 1].y;
      if (!first || !isFinite(first) || !isFinite(last)) return { pct: 0, dir: "-", label: "데이터 오류" };

      const pct = ((last - first) / first) * 100;
      const dir = pct > 0 ? "↑" : (pct < 0 ? "↓" : "→");
      const label = pct > 0 ? "상승" : (pct < 0 ? "하락" : "보합");
      return { pct, dir, label };
    }

    function ensureChart() {
      const ctx = document.getElementById("priceChart").getContext("2d");

      chart = new Chart(ctx, {
        type: "line",
        data: {
          datasets: [{
            label: "BTC (KRW)",
            data: [],           // [{x: Date, y: number}]
            parsing: false,     // x/y 직접 제공
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.2
          }]
        },
        options: {
          animation: false,
          responsive: true,
          maintainAspectRatio: false, // ✅ 컨테이너 높이 고정
          scales: {
            x: {
              type: "time",
              time: {
                unit: "second",
                displayFormats: { second: "HH:mm:ss" }
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 8,
                maxRotation: 0
              }
            },
            y: {
              beginAtZero: false
            }
          },
          plugins: {
            legend: { display: true }
          }
        }
      });
    }

    async function loadHistory() {
      const startedAt = Date.now();

      const debugLines = [];
      debugLines.push(`Fetching: ${API_URL}`);

      let res, rawText, data;
      try {
        res = await fetch(API_URL, { cache: "no-store" });
        rawText = await res.text();
      } catch (e) {
        debugLines.push(`❌ fetch failed: ${String(e)}`);
        setDebug(debugLines);
        return;
      }

      debugLines.push(`HTTP ${res.status}`);

      if (!res.ok) {
        debugLines.push(`Raw response (first 200 chars): ${rawText.slice(0, 200)}`);
        setDebug(debugLines);
        return;
      }

      try {
        data = JSON.parse(rawText);
      } catch (e) {
        debugLines.push("❌ JSON parse failed");
        debugLines.push(`Raw response (first 200 chars): ${rawText.slice(0, 200)}`);
        setDebug(debugLines);
        return;
      }

      const list = Array.isArray(data) ? data : (data.items ?? []);
      if (!Array.isArray(list)) {
        debugLines.push("❌ Response is not an array.");
        setDebug(debugLines);
        return;
      }

      // 원본을 points로 변환
      const points = list
        .map(p => {
          const t = p.createdAt ?? p.fetchedAt;
          const priceNum = Number(p.price);
          if (!t || Number.isNaN(priceNum)) return null;
          return { x: new Date(t), y: priceNum };
        })
        .filter(Boolean);

      if (!chart) ensureChart();

      // ✅ 화면 범위를 최근 WINDOW_MIN분으로 고정
      const max = Date.now();
      const min = max - WINDOW_MIN * 60 * 1000;
      chart.options.scales.x.min = min;
      chart.options.scales.x.max = max;

      // 데이터는 전체 넣되, 화면은 min/max로 잘려 보임
      chart.data.datasets[0].data = points;
      chart.update("none");

      // 화면 구간(최근 WINDOW_MIN분)만 따로 뽑아서 Trend/Last 계산
      const pointsWindow = points.filter(p => p.x.getTime() >= min && p.x.getTime() <= max);

      if (pointsWindow.length === 0) {
        document.getElementById("trendBadge").textContent = "Trend: - (empty)";
        document.getElementById("lastBadge").textContent = "Last: -";
        debugLines.push("OK but empty data (window)");
        setDebug(debugLines);
        return;
      }

      const trend = calcTrend(pointsWindow);
      const lastPoint = pointsWindow[pointsWindow.length - 1];

      document.getElementById("trendBadge").textContent =
        `Trend: ${trend.dir} ${trend.label} (${trend.pct.toFixed(3)}%)`;

      document.getElementById("lastBadge").textContent =
        `Last: ${formatKRW(lastPoint.y)} (${formatKST(lastPoint.x)})`;

      const took = Date.now() - startedAt;
      debugLines.push(`✅ Loaded total=${points.length}, window=${pointsWindow.length}, last=${formatKST(lastPoint.x)}, took=${took}ms`);
      setDebug(debugLines);
    }

    // start
    ensureChart();
    loadHistory();
    setInterval(loadHistory, REFRESH_MS);
  </script>
</body>
</html>